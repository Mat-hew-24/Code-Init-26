<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid-X Host Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        .header {
            background: #16213e;
            padding: 20px;
            border-bottom: 2px solid #0f3460;
        }
        .header h1 {
            color: #00d9ff;
            font-size: 24px;
        }
        .header p {
            color: #888;
            font-size: 14px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .nav a {
            color: #00d9ff;
            text-decoration: none;
            padding: 8px 16px;
            background: #16213e;
            border-radius: 4px;
        }
        .nav a:hover {
            background: #0f3460;
        }
        .section {
            background: #16213e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .section h2 {
            color: #00d9ff;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 1px solid #0f3460;
            padding-bottom: 10px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        .card {
            background: #1a1a2e;
            border-radius: 6px;
            padding: 15px;
            border: 1px solid #0f3460;
        }
        .card h3 {
            color: #fff;
            font-size: 16px;
            margin-bottom: 10px;
        }
        .card .info {
            color: #888;
            font-size: 13px;
            margin-bottom: 5px;
        }
        .card .info span {
            color: #ccc;
        }
        .status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.online {
            background: #00c853;
            color: #000;
        }
        .status.offline {
            background: #ff5252;
            color: #fff;
        }
        .status.running {
            background: #2196f3;
            color: #fff;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #0f3460;
        }
        th {
            background: #0f3460;
            color: #00d9ff;
            font-weight: 600;
        }
        tr:hover {
            background: rgba(0, 217, 255, 0.05);
        }
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        .btn-primary {
            background: #00d9ff;
            color: #000;
        }
        .btn-danger {
            background: #ff5252;
            color: #fff;
        }
        .btn-success {
            background: #00c853;
            color: #000;
        }
        .btn:hover {
            opacity: 0.8;
        }
        .stats-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-box {
            background: #16213e;
            padding: 20px;
            border-radius: 8px;
            flex: 1;
            text-align: center;
        }
        .stat-box .value {
            font-size: 32px;
            color: #00d9ff;
            font-weight: bold;
        }
        .stat-box .label {
            color: #888;
            font-size: 14px;
            margin-top: 5px;
        }
        .refresh-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .refresh-bar span {
            color: #888;
            font-size: 13px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: #16213e;
            padding: 25px;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
        }
        .modal-content h3 {
            color: #00d9ff;
            margin-bottom: 15px;
        }
        .modal-content input, .modal-content textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background: #1a1a2e;
            border: 1px solid #0f3460;
            color: #fff;
            border-radius: 4px;
        }
        .modal-content textarea {
            height: 150px;
            font-family: monospace;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .output-box {
            background: #0a0a14;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .loading {
            color: #888;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Grid-X Host Dashboard</h1>
        <p>Manage workers, jobs, and cluster resources</p>
    </div>

    <div class="container">
        <nav class="nav">
            <a href="/host">Host Dashboard</a>
            <a href="/onboard">+ Add Worker</a>
            <a href="/client">Client Interface</a>
            <a href="/admin">Admin View</a>
            <a href="/docs" target="_blank">API Docs</a>
        </nav>

        <div class="stats-row">
            <div class="stat-box">
                <div class="value" id="workers-online">-</div>
                <div class="label">Workers Online</div>
            </div>
            <div class="stat-box">
                <div class="value" id="jobs-running">-</div>
                <div class="label">Jobs Running</div>
            </div>
            <div class="stat-box">
                <div class="value" id="swarm-nodes">-</div>
                <div class="label">Swarm Nodes</div>
            </div>
            <div class="stat-box">
                <div class="value" id="vpn-status">-</div>
                <div class="label">VPN Status</div>
            </div>
        </div>

        <div class="section">
            <div class="refresh-bar">
                <h2>Workers</h2>
                <div>
                    <span id="last-refresh">Never</span>
                    <button class="btn btn-primary" onclick="refreshAll()">Refresh</button>
                </div>
            </div>
            <table id="workers-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>VPN IP</th>
                        <th>Resources</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="5" class="loading">Loading workers...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <div class="refresh-bar">
                <h2>Jobs</h2>
                <button class="btn btn-success" onclick="showJobModal()">+ New Job</button>
            </div>
            <table id="jobs-table">
                <thead>
                    <tr>
                        <th>Job ID</th>
                        <th>Type</th>
                        <th>Image</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="6" class="loading">Loading jobs...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <h2>Hub Status</h2>
            <div id="hub-status" class="loading">Loading hub status...</div>
        </div>
    </div>

    <!-- Exec Modal -->
    <div class="modal" id="exec-modal">
        <div class="modal-content">
            <h3>Execute Command on <span id="exec-worker-name"></span></h3>
            <input type="text" id="exec-command" placeholder="Enter command (e.g., hostname, nvidia-smi)">
            <div class="output-box" id="exec-output">Output will appear here...</div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="runExec()">Execute</button>
                <button class="btn" onclick="closeModal('exec-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- New Job Modal -->
    <div class="modal" id="job-modal">
        <div class="modal-content">
            <h3>Create New Job</h3>
            <input type="text" id="job-name" placeholder="Job name (optional)">
            <input type="text" id="job-image" placeholder="Docker image (e.g., python:3.11)">
            <input type="text" id="job-command" placeholder="Command (e.g., python -c 'print(1+1)')">
            <input type="text" id="job-cpus" placeholder="CPUs (optional, e.g., 2)">
            <input type="text" id="job-memory" placeholder="Memory (optional, e.g., 4G)">
            <div class="modal-buttons">
                <button class="btn btn-success" onclick="createJob()">Create Job</button>
                <button class="btn" onclick="closeModal('job-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Logs Modal -->
    <div class="modal" id="logs-modal">
        <div class="modal-content" style="width: 700px;">
            <h3>Logs: <span id="logs-job-id"></span></h3>
            <div class="output-box" id="logs-output" style="height: 400px;">Loading logs...</div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="refreshLogs()">Refresh</button>
                <button class="btn" onclick="closeModal('logs-modal')">Close</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let currentExecWorker = '';
        let currentLogsJob = '';

        // Fetch helpers
        async function api(endpoint, method = 'GET', body = null) {
            const options = { method, headers: {} };
            if (body) {
                options.headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(body);
            }
            const resp = await fetch(API_BASE + endpoint, options);
            return resp.json();
        }

        // Load workers
        async function loadWorkers() {
            try {
                const data = await api('/workers');
                const tbody = document.querySelector('#workers-table tbody');
                
                if (!data.workers || data.workers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">No workers registered</td></tr>';
                    document.getElementById('workers-online').textContent = '0';
                    return;
                }

                let onlineCount = 0;
                tbody.innerHTML = data.workers.map(w => {
                    const isOnline = w.online;
                    if (isOnline) onlineCount++;
                    
                    const resources = [];
                    if (w.cpus) resources.push(`${w.cpus} CPU`);
                    if (w.memory) resources.push(`${w.memory}GB RAM`);
                    if (w.gpus) resources.push(`${w.gpus} GPU`);
                    
                    return `
                        <tr>
                            <td><strong>${w.name}</strong></td>
                            <td>${w.ip || '-'}</td>
                            <td>${resources.join(', ') || '-'}</td>
                            <td><span class="status ${isOnline ? 'online' : 'offline'}">${isOnline ? 'ONLINE' : 'OFFLINE'}</span></td>
                            <td>
                                <button class="btn btn-primary" onclick="showExecModal('${w.name}')" ${!isOnline ? 'disabled' : ''}>Exec</button>
                                <button class="btn" onclick="pingWorker('${w.name}')">Ping</button>
                            </td>
                        </tr>
                    `;
                }).join('');

                document.getElementById('workers-online').textContent = `${onlineCount}/${data.workers.length}`;
            } catch (err) {
                console.error('Failed to load workers:', err);
            }
        }

        // Load jobs
        async function loadJobs() {
            try {
                const data = await api('/jobs');
                const tbody = document.querySelector('#jobs-table tbody');
                
                if (!data.jobs || data.jobs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">No jobs found</td></tr>';
                    document.getElementById('jobs-running').textContent = '0';
                    return;
                }

                let runningCount = 0;
                tbody.innerHTML = data.jobs.map(j => {
                    const isRunning = j.running;
                    if (isRunning) runningCount++;
                    
                    return `
                        <tr>
                            <td><strong>${j.id}</strong></td>
                            <td>${j.type || 'job'}</td>
                            <td>${j.image || '-'}</td>
                            <td><span class="status ${isRunning ? 'running' : 'offline'}">${isRunning ? 'RUNNING' : 'STOPPED'}</span></td>
                            <td>${j.created || '-'}</td>
                            <td>
                                <button class="btn btn-primary" onclick="showLogs('${j.id}')">Logs</button>
                                <button class="btn btn-danger" onclick="deleteJob('${j.id}')">Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('');

                document.getElementById('jobs-running').textContent = runningCount;
            } catch (err) {
                console.error('Failed to load jobs:', err);
            }
        }

        // Load hub status
        async function loadHubStatus() {
            try {
                const data = await api('/status');
                const div = document.getElementById('hub-status');
                
                const swarmNodes = data.swarm?.nodes?.length || 0;
                const vpnStatus = data.wireguard?.status || 'unknown';
                
                document.getElementById('swarm-nodes').textContent = swarmNodes;
                document.getElementById('vpn-status').textContent = vpnStatus.toUpperCase();
                
                div.innerHTML = `
                    <div class="grid">
                        <div class="card">
                            <h3>WireGuard VPN</h3>
                            <div class="info">Status: <span>${vpnStatus}</span></div>
                            <div class="info">Hub IP: <span>${data.hub_ip || '-'}</span></div>
                            <div class="info">Public IP: <span>${data.public_ip || '-'}</span></div>
                            <div class="info">Connected Peers: <span>${data.wireguard?.connected_peers || 0}</span></div>
                        </div>
                        <div class="card">
                            <h3>Docker Swarm</h3>
                            <div class="info">Status: <span>${data.swarm?.status || 'unknown'}</span></div>
                            <div class="info">Nodes: <span>${swarmNodes}</span></div>
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error('Failed to load hub status:', err);
            }
        }

        // Refresh all
        async function refreshAll() {
            document.getElementById('last-refresh').textContent = 'Refreshing...';
            await Promise.all([loadWorkers(), loadJobs(), loadHubStatus()]);
            document.getElementById('last-refresh').textContent = new Date().toLocaleTimeString();
        }

        // Ping worker
        async function pingWorker(name) {
            try {
                const data = await api(`/workers/${name}/ping`);
                alert(data.online ? `${name} is ONLINE` : `${name} is OFFLINE`);
            } catch (err) {
                alert('Failed to ping worker');
            }
        }

        // Exec modal
        function showExecModal(name) {
            currentExecWorker = name;
            document.getElementById('exec-worker-name').textContent = name;
            document.getElementById('exec-command').value = '';
            document.getElementById('exec-output').textContent = 'Output will appear here...';
            document.getElementById('exec-modal').classList.add('show');
        }

        async function runExec() {
            const command = document.getElementById('exec-command').value;
            if (!command) return;
            
            document.getElementById('exec-output').textContent = 'Executing...';
            
            try {
                const data = await api(`/workers/${currentExecWorker}/exec`, 'POST', { command });
                let output = '';
                if (data.output) output += data.output;
                if (data.error) output += '\n[STDERR]\n' + data.error;
                output += `\n\n[Exit Code: ${data.exit_code}]`;
                document.getElementById('exec-output').textContent = output;
            } catch (err) {
                document.getElementById('exec-output').textContent = 'Error: ' + err.message;
            }
        }

        // Job modal
        function showJobModal() {
            document.getElementById('job-name').value = '';
            document.getElementById('job-image').value = '';
            document.getElementById('job-command').value = '';
            document.getElementById('job-cpus').value = '';
            document.getElementById('job-memory').value = '';
            document.getElementById('job-modal').classList.add('show');
        }

        async function createJob() {
            const body = {
                image: document.getElementById('job-image').value,
                command: document.getElementById('job-command').value || null,
                name: document.getElementById('job-name').value || null,
                cpus: parseFloat(document.getElementById('job-cpus').value) || null,
                memory: document.getElementById('job-memory').value || null
            };
            
            if (!body.image) {
                alert('Docker image is required');
                return;
            }
            
            try {
                const data = await api('/jobs', 'POST', body);
                if (data.success) {
                    closeModal('job-modal');
                    refreshAll();
                    alert('Job created: ' + data.job_id);
                } else {
                    alert('Failed: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Logs modal
        function showLogs(jobId) {
            currentLogsJob = jobId;
            document.getElementById('logs-job-id').textContent = jobId;
            document.getElementById('logs-output').textContent = 'Loading logs...';
            document.getElementById('logs-modal').classList.add('show');
            refreshLogs();
        }

        async function refreshLogs() {
            try {
                const data = await api(`/jobs/${currentLogsJob}/logs?tail=200`);
                document.getElementById('logs-output').textContent = data.logs || 'No logs available';
            } catch (err) {
                document.getElementById('logs-output').textContent = 'Error: ' + err.message;
            }
        }

        // Delete job
        async function deleteJob(jobId) {
            if (!confirm(`Delete job ${jobId}?`)) return;
            
            try {
                await api(`/jobs/${jobId}`, 'DELETE');
                refreshAll();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Modal helpers
        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        // Initial load
        refreshAll();
        
        // Auto-refresh every 30s
        setInterval(refreshAll, 30000);
    </script>
</body>
</html>
