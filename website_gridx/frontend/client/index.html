<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid-X Client - Colab Lite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #8b5cf6;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border-color: #334155;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, #1a2332 100%);
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
        }

        .header h1 {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 24px;
            font-weight: 700;
        }

        .nav {
            display: flex;
            gap: 8px;
        }

        .nav a {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .nav a:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .main-container {
            display: flex;
            height: calc(100vh - 65px);
        }

        .sidebar {
            width: 300px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h2 {
            color: var(--primary);
            font-size: 12px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            font-weight: 700;
        }

        .worker-list {
            margin-bottom: 24px;
        }

        .worker-item {
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .worker-item:hover {
            border-color: var(--primary);
            background: #3f3f5e;
        }

        .worker-item.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
            box-shadow: 0 0 12px rgba(99, 102, 241, 0.2);
        }

        .worker-item .name {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .worker-item .info {
            font-size: 12px;
            color: var(--text-secondary);
            margin: 2px 0;
        }

        .worker-item .status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .worker-item .status.online {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }

        .worker-item .status.offline {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .editor-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-bottom: 16px;
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .editor-header h3 {
            color: var(--primary);
            font-size: 14px;
            font-weight: 600;
        }

        .editor-tabs {
            display: flex;
            gap: 4px;
        }

        .editor-tab {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .editor-tab.active {
            background: transparent;
            color: var(--primary);
            border-color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }

        .code-editor {
            flex: 1;
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            color: var(--text-primary);
            resize: none;
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .code-editor:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .action-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .action-group {
            display: flex;
            gap: 8px;
            align-items: center;
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 8px;
            background: var(--bg-secondary);
        }
        
        .action-group label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-run {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-analyze {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        
        .btn-analyze:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
        }
        
        .btn-safe {
            background: linear-gradient(135deg, #10b981 0%, #047857 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .btn-safe:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }

        .btn-clear {
            background: var(--bg-tertiary);
            color: var(--error);
            border: 1px solid var(--error);
        }

        .btn-clear:hover {
            background: var(--error);
            color: white;
        }

        .btn-analyze {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        
        .btn-analyze:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
        }
        
        .btn-safe {
            background: linear-gradient(135deg, #10b981 0%, #047857 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .btn-safe:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }

        .action-group {
            display: flex;
            gap: 8px;
            align-items: center;
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 8px;
            background: var(--bg-secondary);
        }
        
        .action-group label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            white-space: nowrap;
        }

        .analysis-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            display: none;
        }
        
        .analysis-panel.visible {
            display: block;
        }
        
        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .analysis-header h4 {
            color: var(--primary);
            font-size: 14px;
            margin: 0;
        }
        
        .issue-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .issue-item {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 4px solid;
            font-size: 13px;
        }
        
        .issue-item.high {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #fca5a5;
        }
        
        .issue-item.medium {
            background: rgba(245, 158, 11, 0.1);
            border-color: #f59e0b;
            color: #fcd34d;
        }
        
        .issue-item.low {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            color: #93c5fd;
        }
        
        .job-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            display: none;
        }
        
        .job-panel.visible {
            display: block;
        }
        
        .job-info {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .job-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .job-status.running {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
        }
        
        .job-status.completed {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }
        
        .job-status.failed {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .analysis-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            display: none;
        }
        
        .analysis-panel.visible {
            display: block;
        }
        
        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .analysis-header h4 {
            color: var(--primary);
            font-size: 14px;
            margin: 0;
        }
        
        .issue-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .issue-item {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 4px solid;
        }
        
        .issue-item.high {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #fca5a5;
        }
        
        .issue-item.medium {
            background: rgba(245, 158, 11, 0.1);
            border-color: #f59e0b;
            color: #fcd34d;
        }
        
        .issue-item.low {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            color: #93c5fd;
        }
        
        .job-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            display: none;
        }
        
        .job-panel.visible {
            display: block;
        }
        
        .job-info {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .job-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .job-status.running {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
        }
        
        .job-status.completed {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }
        
        .job-status.failed {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .output-header h3 {
            color: var(--primary);
            font-size: 14px;
            font-weight: 600;
        }

        .output-box {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            color: #6ee7b7;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .output-box.error {
            color: #fca5a5;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .output-box.running {
            color: #fcd34d;
            border-color: rgba(245, 158, 11, 0.3);
        }

        .worker-select {
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 6px;
            font-size: 13px;
            min-width: 180px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .worker-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .command-input {
            flex: 1;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 6px;
            font-family: 'Fira Code', monospace;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .command-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .quick-commands {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .quick-commands button {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .quick-commands button:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            font-size: 12px;
            color: var(--text-secondary);
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
            animation: pulse 2s infinite;
        }

        .status-dot.ready {
            background: #10b981;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .no-workers {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--bg-tertiary);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .skeleton {
            background: linear-gradient(90deg, var(--bg-tertiary) 25%, #3f3f5e 50%, var(--bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 6px;
            height: 16px;
            margin: 8px 0;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Grid-X Client - Colab Lite</h1>
        <nav class="nav">
            <a href="/host">Host Dashboard</a>
            <a href="/onboard">+ Add Worker</a>
            <a href="/client">Client Interface</a>
            <a href="/admin">Admin View</a>
        </nav>
    </div>

    <div class="main-container">
        <div class="sidebar scrollbar-hide">
            <h2>Available Workers</h2>
            <div class="worker-list" id="worker-list">
                <div class="skeleton"></div>
                <div class="skeleton"></div>
                <div class="skeleton"></div>
            </div>

            <h2 style="margin-top: 20px;">Quick Commands</h2>
            <div class="quick-commands">
                <button onclick="setCommand('python --version')">Python Ver</button>
                <button onclick="setCommand('pip list')">Pip List</button>
                <button onclick="setCommand('nvidia-smi')">GPU Info</button>
                <button onclick="setCommand('free -h')">Memory</button>
                <button onclick="setCommand('df -h')">Disk</button>
                <button onclick="setCommand('ls -la')">List Files</button>
                <button onclick="setCommand('pwd')">PWD</button>
                <button onclick="setCommand('whoami')">Who Am I</button>
                <button onclick="setCommand('hostname')">Hostname</button>
                <button onclick="setCommand('cat /etc/os-release')">OS Info</button>
                <button onclick="setCommand('python -c \"import torch; print(torch.cuda.is_available())\"')">PyTorch CUDA</button>
            </div>

            <h2 style="margin-top: 20px;">Templates</h2>
            <div class="quick-commands">
                <button onclick="loadTemplate('hello')">Hello World</button>
                <button onclick="loadTemplate('numpy')">NumPy Test</button>
                <button onclick="loadTemplate('torch')">PyTorch Test</button>
                <button onclick="loadTemplate('train')">Simple Training</button>
            </div>
        </div>

        <div class="workspace">
            <div class="action-bar">
                <select class="worker-select" id="worker-select">
                    <option value="">Select worker...</option>
                </select>
                <input type="text" class="command-input" id="command-input" placeholder="Enter shell command (or run Python from editor)">
                
                <div class="action-group">
                    <label>üîç Analysis:</label>
                    <button class="btn btn-analyze" onclick="analyzeCode()" id="analyze-btn">
                        <span>üîç</span>
                        <span>Analyze Code</span>
                    </button>
                </div>
                
                <div class="action-group">
                    <label>‚ñ∂ Execute:</label>
                    <button class="btn btn-safe" onclick="safeRunPython()" id="safe-run-btn">
                        <span>üõ°</span>
                        <span>Safe Run</span>
                    </button>
                    <button class="btn btn-run" onclick="runPython()" id="run-python-btn">
                        <span>‚ñ∂</span>
                        <span>Quick Run</span>
                    </button>
                </div>
                
                <button class="btn btn-run" onclick="runCommand()" id="run-btn">
                    <span>‚ñ∂</span>
                    <span>Run Command</span>
                </button>
                <button class="btn btn-clear" onclick="clearOutput()">Clear</button>
                <button class="btn btn-clear" onclick="toggleJobPanel()" id="jobs-btn">Jobs</button>
            </div>

            <!-- Code Analysis Panel -->
            <div class="analysis-panel" id="analysis-panel">
                <div class="analysis-header">
                    <h4>Code Analysis Results</h4>
                    <button class="btn btn-clear" onclick="hideAnalysis()" style="padding: 4px 8px; font-size: 11px;">Close</button>
                </div>
                <div id="analysis-results"></div>
            </div>

            <!-- Job Management Panel -->
            <div class="job-panel" id="job-panel">
                <div class="analysis-header">
                    <h4>Current Job Status</h4>
                    <button class="btn btn-clear" onclick="hideJobPanel()" style="padding: 4px 8px; font-size: 11px;">Close</button>
                </div>
                <div id="job-info"></div>
            </div>

            <div class="editor-section">
                <div class="editor-header">
                    <h3>Python Editor</h3>
                    <div class="editor-tabs">
                        <button class="editor-tab active" onclick="switchTab(event, 'python')">Python</button>
                        <button class="editor-tab" onclick="switchTab(event, 'shell')">Shell Script</button>
                    </div>
                </div>
                <textarea class="code-editor" id="code-editor" placeholder="# Write your Python code here
print('Hello from Grid-X!')

# Example: Basic computation
import sys
print(f'Python version: {sys.version}')

# Add your code below...
"></textarea>
            </div>

            <div class="output-section">
                <div class="output-header">
                    <h3>Output</h3>
                    <span id="exec-time" style="color: var(--text-secondary); font-size: 12px;"></span>
                </div>
                <div class="output-box" id="output-box">Ready. Select a worker and run code.</div>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <span class="status-indicator">
            <span class="status-dot ready" id="status-dot"></span>
            <span id="status-text">Ready</span>
        </span>
        <span id="worker-status">No worker selected</span>
    </div>

    <script>
        const API_BASE = '/api';
        let selectedWorker = null;
        let currentTab = 'python';
        let isExecuting = false;

        // Code templates
        const templates = {
            hello: `# Hello World
print("Hello from Grid-X!")
print("This code is running on a remote worker.")
`,
            numpy: `# NumPy Test
try:
    import numpy as np
    
    # Create arrays
    a = np.array([1, 2, 3, 4, 5])
    b = np.array([10, 20, 30, 40, 50])
    
    print("Array a:", a)
    print("Array b:", b)
    print("Sum:", a + b)
    print("Mean of a:", np.mean(a))
    print("NumPy version:", np.__version__)
except ImportError:
    print("NumPy not installed. Run: pip install numpy")
`,
            torch: `# PyTorch Test
try:
    import torch
    
    print(f"PyTorch version: {torch.__version__}")
    print(f"CUDA available: {torch.cuda.is_available()}")
    
    if torch.cuda.is_available():
        print(f"CUDA version: {torch.version.cuda}")
        print(f"GPU: {torch.cuda.get_device_name(0)}")
        
    # Simple tensor operation
    x = torch.rand(3, 3)
    print("\\nRandom tensor:")
    print(x)
except ImportError:
    print("PyTorch not installed. Run: pip install torch")
`,
            train: `# Simple Training Example
import random
import time

# Simulated training loop
print("Starting training simulation...")

epochs = 5
for epoch in range(epochs):
    loss = 1.0 / (epoch + 1) + random.random() * 0.1
    acc = 0.5 + (epoch * 0.1) + random.random() * 0.05
    print(f"Epoch {epoch+1}/{epochs} - Loss: {loss:.4f} - Accuracy: {acc:.2%}")
    time.sleep(0.5)  # Simulate work

print("\\nTraining complete!")
`
        };

        async function api(endpoint, method = 'GET', body = null) {
            const options = { method, headers: {} };
            if (body) {
                options.headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(body);
            }
            const resp = await fetch(API_BASE + endpoint, options);
            return resp.json();
        }

        async function loadWorkers() {
            try {
                const data = await api('/workers');
                const list = document.getElementById('worker-list');
                const select = document.getElementById('worker-select');
                
                if (!data.workers || data.workers.length === 0) {
                    list.innerHTML = '<div class="no-workers">No workers available</div>';
                    return;
                }

                // Build worker list
                list.innerHTML = data.workers.map(w => `
                    <div class="worker-item ${w.online ? '' : 'offline'}" 
                         onclick="selectWorker(event, '${w.name}')" 
                         id="worker-${w.name}">
                        <div class="name">${w.name}</div>
                        <div class="info">${w.ip || 'No IP'}</div>
                        <div class="info">${w.cpus ? w.cpus + ' CPU' : ''} ${w.memory ? w.memory + 'GB RAM' : ''} ${w.gpus ? w.gpus + ' GPU' : ''}</div>
                        <span class="status ${w.online ? 'online' : 'offline'}">${w.online ? 'ONLINE' : 'OFFLINE'}</span>
                    </div>
                `).join('');

                // Build select options
                select.innerHTML = '<option value="">Select worker...</option>' +
                    data.workers
                        .filter(w => w.online)
                        .map(w => `<option value="${w.name}">${w.name} (${w.ip})</option>`)
                        .join('');

            } catch (err) {
                console.error('Failed to load workers:', err);
            }
        }

        function selectWorker(event, name) {
            event.preventDefault();
            // Update visual selection
            document.querySelectorAll('.worker-item').forEach(el => el.classList.remove('selected'));
            const el = document.getElementById('worker-' + name);
            if (el) el.classList.add('selected');
            
            // Update dropdown
            document.getElementById('worker-select').value = name;
            selectedWorker = name;
            
            document.getElementById('worker-status').textContent = '‚úì Worker: ' + name;
            document.getElementById('status-text').textContent = 'Ready';
        }

        // Sync dropdown to sidebar selection
        document.getElementById('worker-select').addEventListener('change', function() {
            if (this.value) {
                selectWorker(event, this.value);
            }
        });

        function setCommand(cmd) {
            document.getElementById('command-input').value = cmd;
        }

        function loadTemplate(name) {
            if (templates[name]) {
                document.getElementById('code-editor').value = templates[name];
            }
        }

        function switchTab(event, tab) {
            currentTab = tab;
            document.querySelectorAll('.editor-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            const editor = document.getElementById('code-editor');
            if (tab === 'python') {
                editor.placeholder = '# Write your Python code here...';
            } else {
                editor.placeholder = '#!/bin/bash\n# Write your shell script here...';
            }
        }

        async function runCommand() {
            const worker = document.getElementById('worker-select').value;
            const command = document.getElementById('command-input').value;
            
            if (!worker) {
                alert('Please select a worker first');
                return;
            }
            if (!command) {
                alert('Please enter a command');
                return;
            }
            
            await executeOnWorker(worker, command);
        }

        async function runPython() {
            const worker = document.getElementById('worker-select').value;
            const code = document.getElementById('code-editor').value;
            
            if (!worker) {
                alert('Please select a worker first');
                return;
            }
            if (!code.trim()) {
                alert('Please enter some code');
                return;
            }
            
            // Escape the code for shell
            const escapedCode = code.replace(/'/g, "'\\''");
            let command;
            
            if (currentTab === 'python') {
                command = `python3 -c '${escapedCode}'`;
            } else {
                command = `bash -c '${escapedCode}'`;
            }
            
            await executeOnWorker(worker, command);
        }

        async function executeOnWorker(worker, command) {
            const outputBox = document.getElementById('output-box');
            const statusText = document.getElementById('status-text');
            const statusDot = document.getElementById('status-dot');
            const execTime = document.getElementById('exec-time');
            const runBtn = document.getElementById('run-btn');
            const runPythonBtn = document.getElementById('run-python-btn');
            
            if (isExecuting) return;
            isExecuting = true;
            
            // Show loading animation
            outputBox.innerHTML = `<div style="display: flex; align-items: center; gap: 10px; justify-content: center; height: 100%;">
                <div class="loading-spinner"></div>
                <span>Executing code on ${worker}...</span>
            </div>`;
            outputBox.className = 'output-box running';
            statusText.textContent = 'Running on ' + worker + '...';
            statusDot.classList.remove('ready');
            runBtn.disabled = true;
            runPythonBtn.disabled = true;
            
            const startTime = Date.now();
            
            try {
                const data = await api(`/workers/${worker}/exec`, 'POST', { command });
                const duration = ((Date.now() - startTime) / 1000).toFixed(2);
                
                execTime.textContent = `‚è± ${duration}s`;
                
                let output = '';
                if (data.output) output += data.output;
                if (data.error) {
                    if (output) output += '\n';
                    output += '[STDERR]\n' + data.error;
                }
                output += `\n\n[Exit code: ${data.exit_code}]`;
                
                outputBox.textContent = output;
                outputBox.className = 'output-box' + (data.exit_code !== 0 ? ' error' : '');
                statusText.textContent = data.exit_code === 0 ? '‚úì Completed successfully' : '‚úó Completed with errors';
                statusDot.classList.add('ready');
                
            } catch (err) {
                outputBox.textContent = 'Error: ' + err.message;
                outputBox.className = 'output-box error';
                statusText.textContent = '‚úó Error';
                execTime.textContent = '';
            } finally {
                isExecuting = false;
                runBtn.disabled = false;
                runPythonBtn.disabled = false;
            }
        }

        function clearOutput() {
            document.getElementById('output-box').textContent = 'Ready.';
            document.getElementById('output-box').className = 'output-box';
            document.getElementById('exec-time').textContent = '';
            document.getElementById('status-text').textContent = 'Ready';
            document.getElementById('status-dot').classList.add('ready');
        }

        // ============ NEW ENHANCED FUNCTIONALITY ============

        let currentJobId = null;
        let jobCheckInterval = null;

        async function analyzeCode() {
            const code = document.getElementById('code-editor').value.trim();
            const analysisPanel = document.getElementById('analysis-panel');
            const analysisResults = document.getElementById('analysis-results');
            
            if (!code) {
                alert('Please enter some code to analyze');
                return;
            }

            try {
                const response = await api('/exec/analyze', 'POST', { code });
                const { analysis, recommendation } = response;
                
                analysisResults.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <strong>Recommendation:</strong> 
                        <span style="color: ${recommendation === 'safe' ? '#6ee7b7' : '#fca5a5'};">
                            ${recommendation.toUpperCase()}
                        </span>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <strong>Analysis Summary:</strong> ${analysis.analysis_summary.total_issues} issues found
                        (${analysis.analysis_summary.high_severity} high, ${analysis.analysis_summary.medium_severity} medium)
                    </div>
                    
                    <div class="issue-list">
                        ${analysis.issues.map(issue => `
                            <div class="issue-item ${issue.severity}">
                                <strong>Line ${issue.line}:</strong> ${issue.message}
                                ${issue.suggestion ? `<br><em>Suggestion: ${issue.suggestion}</em>` : ''}
                            </div>
                        `).join('')}
                        
                        ${analysis.suggestions.length > 0 ? `
                            <div style="margin-top: 16px;">
                                <strong>General Suggestions:</strong>
                                <ul style="margin: 8px 0; padding-left: 20px;">
                                    ${analysis.suggestions.map(s => `<li>${s}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                analysisPanel.classList.add('visible');
                
            } catch (error) {
                analysisResults.innerHTML = `<div class="issue-item high">Error analyzing code: ${error.message}</div>`;
                analysisPanel.classList.add('visible');
            }
        }

        async function safeRunPython() {
            const worker = selectedWorker || document.getElementById('worker-select').value;
            if (!worker) {
                alert('Please select a worker first');
                return;
            }

            const code = document.getElementById('code-editor').value.trim();
            if (!code) {
                alert('Please enter some Python code to execute');
                return;
            }

            if (isExecuting) return;
            isExecuting = true;

            const outputBox = document.getElementById('output-box');
            const statusText = document.getElementById('status-text');
            const runBtn = document.getElementById('safe-run-btn');
            const analyzeBtn = document.getElementById('analyze-btn');
            
            // Show loading
            outputBox.innerHTML = `<div style="display: flex; align-items: center; gap: 10px; justify-content: center; height: 100%;">
                <div class="loading-spinner"></div>
                <span>Analyzing and executing code safely...</span>
            </div>`;
            outputBox.className = 'output-box running';
            statusText.textContent = 'Safe execution starting...';
            runBtn.disabled = true;
            analyzeBtn.disabled = true;

            try {
                // Submit job for safe execution
                const jobResponse = await api('/exec/safe-execute', 'POST', {
                    worker: worker,
                    code: code,
                    user_id: 'web-client',
                    allow_risky: false,
                    timeout: null  // No timeout for LLM workloads
                });

                if (!jobResponse.success) {
                    throw new Error(jobResponse.error || 'Failed to submit job');
                }

                currentJobId = jobResponse.job_id;
                
                // Show job panel
                updateJobPanel(jobResponse.job_id);
                document.getElementById('job-panel').classList.add('visible');
                
                // Start monitoring job
                monitorJob(jobResponse.job_id);
                
            } catch (error) {
                outputBox.textContent = 'Error: ' + error.message;
                outputBox.className = 'output-box error';
                statusText.textContent = '‚úó Error';
                isExecuting = false;
                runBtn.disabled = false;
                analyzeBtn.disabled = false;
            }
        }

        async function monitorJob(jobId) {
            if (!jobId) return;
            
            jobCheckInterval = setInterval(async () => {
                try {
                    const job = await api(`/exec/jobs/${jobId}`, 'GET');
                    updateJobPanel(jobId, job);
                    
                    if (job.status === 'completed' || job.status === 'failed' || job.status === 'cancelled') {
                        clearInterval(jobCheckInterval);
                        jobCheckInterval = null;
                        currentJobId = null;
                        isExecuting = false;
                        document.getElementById('safe-run-btn').disabled = false;
                        document.getElementById('analyze-btn').disabled = false;
                        
                        // Show final results
                        const outputBox = document.getElementById('output-box');
                        const statusText = document.getElementById('status-text');
                        
                        if (job.status === 'completed' && job.result) {
                            let output = '';
                            if (job.result.output) output += job.result.output;
                            if (job.result.error) {
                                if (output) output += '\\n';
                                output += '[STDERR]\\n' + job.result.error;
                            }
                            output += `\\n\\n[Job completed in ${job.metrics.execution_time.toFixed(2)}s]`;
                            
                            outputBox.textContent = output;
                            outputBox.className = 'output-box' + (job.result.exit_code !== 0 ? ' error' : '');
                            statusText.textContent = job.result.exit_code === 0 ? '‚úì Completed successfully' : '‚úó Completed with errors';
                        } else {
                            outputBox.textContent = `Job ${job.status}: ${job.error || 'Unknown error'}`;
                            outputBox.className = 'output-box error';
                            statusText.textContent = `‚úó Job ${job.status}`;
                        }
                    }
                } catch (error) {
                    console.error('Error monitoring job:', error);
                }
            }, 2000); // Check every 2 seconds
        }

        async function updateJobPanel(jobId, jobData = null) {
            const jobInfo = document.getElementById('job-info');
            
            try {
                const job = jobData || await api(`/exec/jobs/${jobId}`, 'GET');
                
                const progressPercent = Math.round(job.metrics.progress * 100);
                const duration = job.metrics.execution_time || 0;
                
                jobInfo.innerHTML = `
                    <div class="job-info">
                        <span><strong>Job ID:</strong> ${job.job_id.substring(0, 8)}...</span>
                        <span class="job-status ${job.status}">${job.status}</span>
                        <span><strong>Worker:</strong> ${job.worker}</span>
                        <span><strong>Duration:</strong> ${duration.toFixed(1)}s</span>
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; align-items: center; font-size: 12px; color: var(--text-secondary);">
                        <span>Progress: ${progressPercent}%</span>
                        ${job.status === 'running' ? `
                            <button class="btn btn-clear" onclick="cancelJob('${job.job_id}')" style="padding: 4px 12px; font-size: 11px;">
                                Cancel Job
                            </button>
                        ` : ''}
                    </div>
                `;
                
            } catch (error) {
                jobInfo.innerHTML = `<div class="issue-item high">Error loading job details: ${error.message}</div>`;
            }
        }

        async function cancelJob(jobId) {
            if (!confirm('Are you sure you want to cancel this job?')) return;
            
            try {
                await api(`/exec/jobs/${jobId}/control`, 'POST', null, { action: 'cancel' });
                if (jobCheckInterval) {
                    clearInterval(jobCheckInterval);
                    jobCheckInterval = null;
                }
                currentJobId = null;
                isExecuting = false;
                document.getElementById('safe-run-btn').disabled = false;
                document.getElementById('analyze-btn').disabled = false;
            } catch (error) {
                alert('Failed to cancel job: ' + error.message);
            }
        }

        function hideAnalysis() {
            document.getElementById('analysis-panel').classList.remove('visible');
        }

        function hideJobPanel() {
            document.getElementById('job-panel').classList.remove('visible');
        }

        function toggleJobPanel() {
            const panel = document.getElementById('job-panel');
            if (panel.classList.contains('visible')) {
                hideJobPanel();
            } else {
                if (currentJobId) {
                    updateJobPanel(currentJobId);
                } else {
                    document.getElementById('job-info').innerHTML = '<div>No active jobs</div>';
                }
                panel.classList.add('visible');
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+Enter to run Python
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                runPython();
            }
            // Shift+Enter to run command
            if (e.shiftKey && e.key === 'Enter' && document.activeElement.id === 'command-input') {
                e.preventDefault();
                runCommand();
            }
        });

        // Initial load
        loadWorkers();
        
        // Refresh workers every 30s
        setInterval(loadWorkers, 30000);
    </script>
</body>
</html>
