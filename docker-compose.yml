version: '3.8'

services:
  # ============== HUB ==============
  hub:
    build: .
    container_name: gridx-hub
    hostname: hub
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
    ports:
      - "51820:51820/udp"  # WireGuard
      - "8888:8888"        # Jupyter (forwarded from workers)
    volumes:
      - /lib/modules:/lib/modules:ro
      - hub-docker:/var/lib/docker
      - hub-gridx:/etc/gridx
    networks:
      gridx-net:
        ipv4_address: 172.20.0.10
    environment:
      - ROLE=hub
    command: >
      sh -c "
        dockerd &
        sleep 5
        echo '=== HUB READY ==='
        echo 'Run: python hub.py init --ip 172.20.0.10'
        tail -f /dev/null
      "

networks:
  gridx-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24

volumes:
  hub-docker:
  hub-gridx:
